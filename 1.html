<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Made with hands</title>
  <!--<link rel="stylesheet" href="style.css">-->
  <!--<script src="node_modules/plastiq/plastiq.js"></script>-->
  <script src="plastiq/plastiq.js"></script>
  <script src="plastiq.js"></script>
  <script src="140medley.js"></script>
  <script src="graph.js"></script>
  <script>
	var h = plastiq.html;
	var bind = plastiq.bind;
    var refresh = plastiq.html.refresh;

	function partial(fn /*, args...*/) {
		// A reference to the Array#slice method.
		var slice = Array.prototype.slice;
		// Convert arguments object to an array, removing the first argument.
		var args = slice.call(arguments, 1);

		return function() {
			// Invoke the originally-specified function, passing in all originally-
			// specified arguments, followed by any just-specified arguments.
			return fn.apply(this, args.concat(slice.call(arguments, 0)));
		};
 	}

	//function newCC(component) {
	//	var componentContainer = { _instances: new Array() };
	//	componentContainer._function = partial(component, componentContainer._instances);
	//	return componentContainer;
	//}

	//function useCC(componentContainer) {
	//	var component = h.component(componentContainer._function);
	//	componentContainer._instances.push(component);
	//	return component;
	//}

	//function democomp(instances, model) {
	//	return h('button', {onclick: function () { 
	//				model.counter++;
	//				return instances; 
	//			}}, 'refresh components');
	//}


	function hashSetHasKey(hashSet, key) {
		return hashSet.hasOwnProperty(key);
	}
	
	function renderTriples(model) {
		return renderLevel(model, 0);
	}
	function renderLevel(model, depth) {

		return h('div', model.graph._graph.map(function (triple) {
			return h('div',
				renderLevelPosition(model, triple, 's'), ' ',
				renderLevelPosition(model, triple, 'p'), ' ',
				renderLevelPosition(model, triple, 'o')
				);
		}));
	}
	function renderLevelPosition(model, triple, position) {
		return entityController(model, triple, position);
	}
	function entityController(model, triple, position) {
        var controllerEventHandler = function (handler, model, triple, position, e) {
            return function (e) {
                partial(handler, model, triple, position).apply(this, arguments);
                if (e.preventDefault) {
                    e.preventDefault();
                } else {
                    e.returnValue = false;
                }
            }
        }
		var style = {};
		if (model.meta.currentNode == triple[position]) {
			style.color = 'red';
		}
		return h('span', {
				style: style,
				tabIndex: 0,
				onkeydown: controllerEventHandler(controllerKeydown, model, triple, position),
				onclick: controllerEventHandler(controllerClick, model, triple, position),
                onfocus: refreshMeta
			}, triple[position]);
	}
    
    function refreshMeta(model, triple, position) {
        if (model.meta.currentNode != triple[position]) {
            model.meta.previousNode = model.meta.currentNode;
            model.meta.currentNode = triple[position];
        }
    }
    
    function controllerClick(model, triple, position, e) { 
        //triple[position] = triple[position] + 'a';
        model.graph.replaceNode(triple, position, triple[position] + 'a');
        refreshMeta(model, triple, position);
    }
    
    function controllerKeydown(model, triple, position, e) {
        $('#t').textContent = e.keyCode;
        refreshMeta(model, triple, position);
    }

	function renderLevelPositionSimple(entity, componentContainerDict) {
		return h('div', entity);
	}

	var graph = new Graph();
	graph.addTriple(Graph.makeTriple("testS", "testP", "testO"));
	graph.addTriple(Graph.makeTriple("testS", "testP2", "testO"));
	graph.addTriple(Graph.makeTriple("testO", "testP3", "testO3"));

	//var defaultTriples = [ { s: "testS", p: "testP", o: "testO" }, { s: "testS", p: "testP2", o: "testO" }, { s: "testO", p: "testP3", o: "testO3" } ];

	var k = function (e) {
	  $('#t').textContent = e.keyCode;
      e.preventDefault();
	  return false;
	};
    window.onload = function () {
		//$('#h').onkeydown = k;
	
		//plastiq.append(document.body, render, {name: '', m2: {counter: 0}, counter2: 0});
		var model0 = { graph: graph, // defaultTriples, 
		  	meta: { currentNode: "testO", previousNode: null } };
		plastiq.append(document.body, function (model) { return renderTriples(model); }, model0);

		setInterval(function() { $('#graph').textContent = JSON.stringify(model0); }, 1000);
    };
  </script>
</head>
<body>

  <h1 id="h" tabindex="0">Semaea</h1>
  <p tabindex="0">
    asd
  </p>

  <textarea id="t">asdasda</textarea>
  
  <p>Make something <strong>amazing</strong> with the web!</p>

  <p id="graph">graph<p>

</body>
</html>

