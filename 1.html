<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Made with hands</title>
  <!--<link rel="stylesheet" href="style.css">-->
  <!--<script src="node_modules/plastiq/plastiq.js"></script>-->
  <script src="plastiq/plastiq.js"></script>
  <script src="140medley.js"></script>
  <script>
	var h = plastiq.html;
	var bind = plastiq.bind;

	function partial(fn /*, args...*/) {
		// A reference to the Array#slice method.
		var slice = Array.prototype.slice;
		// Convert arguments object to an array, removing the first argument.
		var args = slice.call(arguments, 1);

		return function() {
			// Invoke the originally-specified function, passing in all originally-
			// specified arguments, followed by any just-specified arguments.
			return fn.apply(this, args.concat(slice.call(arguments, 0)));
		};
 	}

	function newCC(component) {
		var componentContainer = { _instances: new Array() };
		componentContainer._function = partial(component, componentContainer._instances);
		return componentContainer;
	}

	function useCC(componentContainer) {
		var component = h.component(componentContainer._function);
		componentContainer._instances.push(component);
		return component;
	}

	function democomp(instances, model) {
		return h('button', {onclick: function () { 
					model.counter++;
					return instances; 
				}}, 'refresh components');
	}


	function hashSetHasKey(hashSet, key) {
		return hashSet.hasOwnProperty(key);
	}
	
	function renderTriples(triples, meta) {
		var componentContainerDict = {};
		return renderLevel(triples, meta, componentContainerDict, 0);
	}
	function renderLevel(triples, meta, componentContainerDict, depth) {

		return h('div', triples.map(function (triple) {
			return h('div',
				renderLevelPosition(meta, triple, 's', componentContainerDict), ' ',
				renderLevelPosition(meta, triple, 'p', componentContainerDict), ' ',
				renderLevelPosition(meta, triple, 'o', componentContainerDict)
				);
		}));
	}
	function renderLevelPosition(meta, triple, position, componentContainerDict) {
		var entity = triple[position];
		if(hashSetHasKey(componentContainerDict, entity)) {
			return useCC(componentContainerDict[entity]);
		} else {
			var cc = newCC(partial(entityController, meta, triple, position));
			componentContainerDict[entity] = cc;
			return useCC(cc);
		}
	}
	function entityController(meta, triple, position, instances) {
		var style = {};
		if (meta.currentNode == triple[position]) {
			style.color = 'red';
		}
		return h('span', {
				style: style,
				tabIndex: 0,
				onkeydown: k,
				onclick: function () { 
					triple[position] = triple[position] + 'a';
					return instances; 
				}
			}, triple[position]);
	}

	function renderLevelPositionSimple(entity, componentContainerDict) {
		return h('div', entity);
	}


	var defaultTriples = [ { s: "testS", p: "testP", o: "testO" }, { s: "testS", p: "testP2", o: "testO" }, { s: "testO", p: "testP3", o: "testO3" } ];

		var k = function (e) {
		  $('#t').textContent = e.keyCode;
		  return false;
		};
    window.onload = function () {
		$('#h').onkeydown = k;
	
		//plastiq.append(document.body, render, {name: '', m2: {counter: 0}, counter2: 0});
		var model0 = { triples: defaultTriples, meta: { currentNode: "testO" } };
		plastiq.append(document.body, function (model) { return renderTriples(model.triples, model.meta); }, model0);

		setInterval(function() { $('#graph').textContent = JSON.stringify(model0); }, 1000);
    };
  </script>
</head>
<body>

  <h1 id="h" tabindex="0">Semaea</h1>
  <p tabindex="0">
    asd
  </p>

  <textarea id="t">asdasda</textarea>
  
  <p>Make something <strong>amazing</strong> with the web!</p>

  <p id="graph">graph<p>

</body>
</html>

